<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="../assets/img/favicon.png">
  <title>
    FoodGuard PRO -
  </title>
  <!--     Fonts and icons     -->
  <link href="https://fonts.googleapis.com/css?family=Inter:300,400,500,600,700,800" rel="stylesheet" />
  <!-- Nucleo Icons -->
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="https://demos.creative-tim.com/soft-ui-dashboard/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <script src="/vendor/sweetalert2/dist/sweetalert2.all.min.js"></script>
  <!-- CSS Files -->
  <link id="pagestyle" href="/assets/css/soft-ui-dashboard.css?v=1.1.0" rel="stylesheet" />
  <!-- Nepcha Analytics (nepcha.com) -->

</head>

<body class="g-sidenav-show  bg-gray-100">
  <aside class="sidenav navbar navbar-vertical navbar-expand-xs border-0 border-radius-xl my-3 fixed-start ms-3 "
    id="sidenav-main">
    <%- include('../partials/sidehead') %>
      <hr class="horizontal dark mt-0">
      <%- include('../partials/sidebar') %>
  </aside>
  <main class="main-content position-relative max-height-vh-100 h-100 border-radius-lg ">
    <!-- Navbar -->
    <%- include('../partials/navbar') %>
      <!-- End Navbar -->

      <div class="container-fluid py-4">
        <div class="row">
          <div class="col-lg-12 col-12">
            <div class="row g-3">

              <!-- Total Sekolah -->
              <div class="col-lg-3 col-md-6 col-12">
                <div class="card">
                  <span class="mask bg-info opacity-10 border-radius-lg"></span>
                  <div class="card-body p-3 position-relative">
                    <div class="row">
                      <div class="col-8 text-start">
                        <div
                          class="icon icon-shape bg-white shadow text-center border-radius-2xl d-flex align-items-center justify-content-center"
                          style="width:60px; height:60px;">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="CurrentColor">
                            <path
                              d="M240-200h120v-240h240v240h120v-360L480-740 240-560v360Zm-80 80v-480l320-240 320 240v480H520v-240h-80v240H160Zm320-350Z" />
                          </svg>
                        </div>
                        <h5 class="text-white font-weight-bolder mb-0 mt-3">
                          <%= totalSekolah %>
                        </h5>
                        <span class="text-white text-sm">Total Sekolah</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Sekolah Aktif -->
              <div class="col-lg-3 col-md-6 col-12">
                <div class="card">
                  <span class="mask bg-success opacity-10 border-radius-lg"></span>
                  <div class="card-body p-3 position-relative">
                    <div class="row">
                      <div class="col-8 text-start">
                        <div
                          class="icon icon-shape bg-white shadow text-center border-radius-2xl d-flex align-items-center justify-content-center"
                          style="width:60px; height:60px;">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="CurrentColor">
                            <path
                              d="M480-510ZM160-160v-375l-72 55-47-63 439-337 440 336-48 64-392-300-240 184v356h120v80H160Zm437 80L428-250l56-57 113 113 227-226 56 57L597-80Z" />
                          </svg>
                        </div>
                        <h5 class="text-white font-weight-bolder mb-0 mt-3">
                          <%= sekolahAktif %>
                        </h5>
                        <span class="text-white text-sm">Sekolah Aktif</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Device Bermasalah -->
              <div class="col-lg-3 col-md-6 col-12">
                <div class="card">
                  <span class="mask bg-danger opacity-10 border-radius-lg"></span>
                  <div class="card-body p-3 position-relative">
                    <div class="row">
                      <div class="col-8 text-start">
                        <div
                          class="icon icon-shape bg-white shadow text-center border-radius-2xl d-flex align-items-center justify-content-center"
                          style="width:60px; height:60px;">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="CurrrentColor">
                            <path
                              d="M280-40q-33 0-56.5-23.5T200-120v-720q0-33 23.5-56.5T280-920h400q33 0 56.5 23.5T760-840v124q18 7 29 22t11 34v80q0 19-11 34t-29 22v404q0 33-23.5 56.5T680-40H280Zm0-80h400v-720H280v720Zm0 0v-720 720Zm106-210 94-94 94 94 56-56-94-94 94-94-56-56-94 94-94-94-56 56 94 94-94 94 56 56Z" />
                          </svg>
                        </div>
                        <h5 class="text-white font-weight-bolder mb-0 mt-3">
                          <%= sekolahNonaktif %>
                        </h5>
                        <span class="text-white text-sm">Device Bermasalah</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Laporan -->
              <div class="col-lg-3 col-md-6 col-12">
                <div class="card">
                  <span class="mask bg-dark opacity-10 border-radius-lg"></span>
                  <div class="card-body p-3 position-relative">
                    <div class="row">
                      <div class="col-8 text-start">
                        <div
                          class="icon icon-shape bg-white shadow text-center border-radius-2xl d-flex align-items-center justify-content-center"
                          style="width:60px; height:60px;">
                          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px"
                            fill="CurentColor">
                            <path
                              d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h168q13-36 43.5-58t68.5-22q38 0 68.5 22t43.5 58h168q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-80h560v-560H200v560Zm80-80h280v-80H280v80Zm0-160h400v-80H280v80Zm0-160h400v-80H280v80Zm200-190q13 0 21.5-8.5T510-820q0-13-8.5-21.5T480-850q-13 0-21.5 8.5T450-820q0 13 8.5 21.5T480-790ZM200-200v-560 560Z" />
                          </svg>
                        </div>
                        <h5 class="text-white font-weight-bolder mb-0 mt-3">
                          1600
                        </h5>
                        <span class="text-white text-sm">Total Laporan dibuat</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <% if (flash) { %>
                <script>
                  Swal.fire({
                    icon: '<%= flash.type %>',
                    title: 'INFO',
                    text: '<%= flash.message %>',
                    timer: 2000,
                    showConfirmButton: false
                  })
                </script>
                <% } %>


                  <div class="row my-4">
                    <div class="col-lg-12 col-md-6 mb-md-0 mb-4">
                      <div class="card">
                        <div class="card-header pb-0">
                          <div class="row align-items-center">
                            <div class="col-lg-6 col-7">
                              <h6>
                                <%= pageTitle || 'Daftar Sekolah' %>
                              </h6>
                              <p class="text-sm mb-0">
                                <i class="fa fa-check text-info" aria-hidden="true"></i>
                                <span class="font-weight-bold ms-1" id="totalSekolah">
                                  <%= sekolah ? sekolah.length : 0 %>
                                </span> Total Sekolah
                              </p>
                            </div>
                            <div class="col-lg-6 col-5 text-end">
                              <a class="btn btn-success mt-3" href="/sekolah/tambah">
                                <i class="fa fa-plus me-1"></i>Tambah Sekolah</a>
                            </div>
                          </div>

                          <!-- Filter Section -->
                          <div class="row mt-4 g-3">
                            <div class="col-md-3">
                              <label class="form-label fw-bold">Search</label>
                              <div class="input-group">
                                <span class="input-group-text bg-white border-end-0"><i
                                    class="fas fa-search"></i></span>
                                <input id="searchInput" type="text" class="form-control border-start-0"
                                  placeholder="Cari sekolah..." />
                              </div>
                            </div>
                            <div class="col-md-3">
                              <label class="form-label fw-bold">Provinsi</label>
                              <select id="filterProvinsi" class="form-select">
                                <option value="">Semua Provinsi</option>
                                <% if (provinsiList) { provinsiList.forEach(p=> { %>
                                  <option value="<%= p %>">
                                    <%= p %>
                                  </option>
                                  <% }) } %>
                              </select>
                            </div>
                            <div class="col-md-3">
                              <label class="form-label fw-bold">Kota/Kabupaten</label>
                              <select id="filterKota" class="form-select">
                                <option value="">Semua Kota</option>
                                <% if (kotaList) { kotaList.forEach(k=> { %>
                                  <option value="<%= k %>">
                                    <%= k %>
                                  </option>
                                  <% }) } %>
                              </select>
                            </div>
                            <div class="col-md-3">
                              <label class="form-label fw-bold">Status</label>
                              <select id="filterStatus" class="form-select">
                                <option value="">Semua Status</option>
                                <option value="aktif">Aktif</option>
                                <option value="nonaktif">Tidak Aktif</option>
                              </select>
                            </div>
                          </div>
                        </div>

                        <div class="card-body px-0 pb-2">
                          <div class="table-responsive">
                            <table id="sekolahTable" class="table align-items-center mb-0">
                              <thead>
                                <tr>
                                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-3">
                                    ID
                                    Sekolah</th>
                                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Nama
                                    Sekolah</th>
                                  <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">
                                    Lokasi</th>
                                  <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    SPPG</th>
                                  <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    Status Sistem</th>
                                  <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    Kasus Keracunan</th>
                                  <th
                                    class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">
                                    Aksi</th>
                                </tr>
                              </thead>
                              <tbody id="sekolahTableBody">
                                <!-- Data di-inject via AJAX -->
                              </tbody>
                            </table>
                            <div id="paginationContainer" class="mt-4 d-flex justify-content-center gap-2">
                              <!-- Pagination di-inject via AJAX -->
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>


                  <footer class="sticky-bottom footer pt-3  ">
                    <div class="container-fluid">
                      <div class="row align-items-center justify-content-lg-between">
                        <div class="col-lg-6 mb-lg-0 mb-4">
                          <div class="copyright text-center text-sm text-muted text-lg-start">
                            Â©
                            <script>
                              document.write(new Date().getFullYear())
                            </script>,
                            Irostech
                          </div>
                        </div>
                      </div>
                    </div>
                  </footer>

            </div>
  </main>

  <!--   Core JS Files   -->
  <script src="../assets/js/core/popper.min.js"></script>
  <script src="../assets/js/core/bootstrap.min.js"></script>
  <script src="../assets/js/plugins/perfect-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/smooth-scrollbar.min.js"></script>
  <script src="../assets/js/plugins/chartjs.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script>
    const searchInput = $('#searchInput');
    const filterProvinsi = $('#filterProvinsi');
    const filterKota = $('#filterKota');
    const filterStatus = $('#filterStatus');
    const tableBody = $('#sekolahTableBody');
    const paginationContainer = $('#paginationContainer');

    function loadPage(page = 1) {
      const search = searchInput.val();
      const provinsi = filterProvinsi.val();
      const kota = filterKota.val();
      const status = filterStatus.val();

      $.get('/sekolah/datasekolah', { page, search, provinsi, kota, status }, function (res) {
        if (res.error) {
          alert(res.error);
          return;
        }

        // Inject table rows
        let rows = '';
        res.data.forEach(s => {
          rows += `
          <tr>
            <td class="ps-3"><h6 class="mb-0 text-sm">${s.id_sekolah}</h6></td>
            <td><h6 class="mb-0 text-sm">${s.nama_sekolah}</h6></td>
            <td>
              <h6 class="mb-0 text-sm">${s.kota}</h6>
              <span class="text-xxs text-secondary">${s.provinsi}</span>
            </td>
            <td class="text-center"><h6 class="mb-0 text-sm">${s.satuan_gizi.nama_sppg}</h6></td>
            <td class="text-center">
  <span class="badge ${s.status_sistem === 'aktif'
              ? 'bg-success'
              : s.status_sistem === 'nonaktif'
                ? 'bg-danger'
                : 'bg-warning'
            }">
    ${s.status_sistem}
  </span>
</td>

<td class="text-center">
  <span class="badge ${s.kasus_keracunan === 'aman'
              ? 'bg-success'
              : s.kasus_keracunan === 'bahaya'
                ? 'bg-danger'
                : 'bg-warning'
            }">
    ${s.kasus_keracunan}
  </span>
</td>
            <td class="text-center">
              <a class="btn btn-outline-info btn-sm px-3 mb-0" href="/sekolah/detail/${s.id_sekolah}">
              <svg xmlns="http://www.w3.org/2000/svg" height="18px" viewBox="0 -960 960 960" width="18px" fill="CurrentColor"><path d="M480-320q75 0 127.5-52.5T660-500q0-75-52.5-127.5T480-680q-75 0-127.5 52.5T300-500q0 75 52.5 127.5T480-320Zm0-72q-45 0-76.5-31.5T372-500q0-45 31.5-76.5T480-608q45 0 76.5 31.5T588-500q0 45-31.5 76.5T480-392Zm0 192q-146 0-266-81.5T40-500q54-137 174-218.5T480-800q146 0 266 81.5T920-500q-54 137-174 218.5T480-200Zm0-300Zm0 220q113 0 207.5-59.5T832-500q-50-101-144.5-160.5T480-720q-113 0-207.5 59.5T128-500q50 101 144.5 160.5T480-280Z"/></svg>
              </a>
            </td>
          </tr>
        `;
        });
        tableBody.html(rows);

        // Inject pagination
        let paginationHTML = '';
        if (res.currentPage > 1) {
          paginationHTML += `<button class="btn btn-sm btn-outline-info" onclick="loadPage(${res.currentPage - 1})">Previous</button>`;
        }
        for (let i = 1; i <= res.totalPages; i++) {
          paginationHTML += `<button class="btn btn-sm ${res.currentPage === i ? 'btn-info' : 'btn-outline-info'}" onclick="loadPage(${i})">${i}</button>`;
        }
        if (res.currentPage < res.totalPages) {
          paginationHTML += `<button class="btn btn-sm btn-outline-info" onclick="loadPage(${res.currentPage + 1})">Next</button>`;
        }
        paginationContainer.html(paginationHTML);
      });
    }

    // Trigger loadPage saat input/filter berubah
    searchInput.on('input', () => loadPage(1));
    filterProvinsi.on('change', () => loadPage(1));
    filterKota.on('change', () => loadPage(1));
    filterStatus.on('change', () => loadPage(1));

    // Load halaman pertama saat halaman siap
    $(document).ready(() => loadPage());
  </script>
  <script>
    var win = navigator.platform.indexOf('Win') > -1;
    if (win && document.querySelector('#sidenav-scrollbar')) {
      var options = {
        damping: '0.5'
      }
      Scrollbar.init(document.querySelector('#sidenav-scrollbar'), options);
    }
  </script>
  <!-- Github buttons -->
  <script async defer src="https://buttons.github.io/buttons.js"></script>
  <!-- Control Center for Soft Dashboard: parallax effects, scripts for the example pages etc -->
  <script src="../assets/js/soft-ui-dashboard.min.js?v=1.1.0"></script>
</body>

</html>